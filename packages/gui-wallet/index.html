<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css">
    <link rel="stylesheet" href="//cdn.rawgit.com/milligram/milligram/master/dist/milligram.min.css">

    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
    <script src="https://unpkg.com/axios@0.18.0/dist/axios.js"></script>
    <title>Simple Wallet</title>
  </head>

  <script type="text/javascript">
    $(document).ready(function() {
      var COUNT_PER_PAGE = 20;
      var State = {
        isLogin: false,
        timer: null,
      };
      var UserInfo = {
        secret: '',
      };
      function updateBalanceView(balances) {
        var $table = $('#balanceTable');
        $table.find('tr:not(:first)').remove();
        for (var i in balances) {
          var balanceInfo = balances[i];
          var balance = Number(balanceInfo.balance) / 100000000;
          var currency = balanceInfo.currency;
          var tr =
            '<tr><td>' + currency + '</td>' + '<td>' + balance + '</td></tr>';
          $table.append(tr);
        }
      }
      function updateTransactionView(address) {
        const getTrsUrl = '/api/transactions?senderId=' + address;
        console.log(getTrsUrl);
        axios.get(getTrsUrl)
          .then(response => {
            const transactions = response.data.transactions;
            console.log(transactions);

            var $transTable = $('#transactionTable');
            $transTable.find('tr:not(:first)').remove();
            for(let i = 0; i < transactions.length; ++i) {
              const one = transactions[i];

              var tr = '<tr>' 
                + '<td>' + one.type + '</td>'
                + '<td>' + one.height + '</td>'
                + '<td>' + one.args + '</td>'
                + '<td>' + one.timestamp + '</td>'
                + '<td>' + one.senderId + '</td>'
                + '</tr>';
              $transTable.append(tr);
            }
          })
          .catch(error => {
            console.log(error.response.data);
          })
      }
      function loadContracts() {
        var $contractOptions = $('#contractOptions');
        $contractOptions.empty();

        const transfer = JSON.stringify({ type: 0, fee: 0.1 * 1e8, });
        const setUserName = JSON.stringify({ type: 1, fee: 5 * 1e8, });
        const setSecondPassphrase = JSON.stringify({ type: 2, fee: 5 * 1e8, });
        const lock = JSON.stringify({ type: 3, fee: 0.1 * 1e8, });
        const vote = JSON.stringify({ type: 4, fee: 0.1 * 1e8, });
        const unvote = JSON.stringify({ type: 5, fee: 0.1 * 1e8, });
        const unlock = JSON.stringify({ type: 6, fee: 0 * 1e8, });
        const registerDelegate = JSON.stringify({ type: 10, fee: 100 * 1e8, })

        const registerIssuer = JSON.stringify({ type: 100, fee: 100 * 1e8, });
        const registerAsset = JSON.stringify({ type: 101, fee: 500 * 1e8, });
        const issue = JSON.stringify({ type: 102, fee: 0.1, });
        const assetTransfer = JSON.stringify({ type: 103, fee: 0.1 * 1e8, });

        $contractOptions.append(`<option value=${transfer}>#0 basic.transfer</option`);
        $contractOptions.append(`<option value=${setUserName}>#1 basic.setUserName</option`);
        $contractOptions.append(`<option value=${setSecondPassphrase}>#2 basic.setSecondPassPhrase</option`);
        $contractOptions.append(`<option value=${lock}>#3 basic.lock</option`);
        $contractOptions.append(`<option value=${vote}>#4 basic.vote</option`);
        $contractOptions.append(`<option value=${unvote}>#5 basic.unvote</option`);
        $contractOptions.append(`<option value=${unlock}>#6 basic.unlock</option`);
        $contractOptions.append(`<option value=${registerDelegate}>#10 basic.registerDelegate</option`);

        $contractOptions.append(`<option value=${registerIssuer}>#100 uia.registerIssuer</option`);
        $contractOptions.append(`<option value=${registerAsset}>#101 uia.registerAsset</option`);
        $contractOptions.append(`<option value=${issue}>#102 uia.issue</option`);
        $contractOptions.append(`<option value=${assetTransfer}>#103 uia.transfer</option`);
      }

      function updateAccount(account) {
        updateBalanceView(account.balances);
        updateTransactionView(account.address);
      }
      function onLogin(account) {
        State.isLogin = true;
        $('#loginBtn').html('Logout');
        $('#secretInput').hide();
        $('#mainPanel').show();
        updateBalanceView(account.balances);
        updateTransactionView(account.address);
        loadContracts();

        State.timer = setInterval(function() {
          console.log('refetch data');
          if (UserInfo.publicKey) {
            login(UserInfo.secret, (err, account) => {
              UserInfo = account;
              updateAccount(account);
            });
          }
        }, 5 * 1000);
      }
      function login(secret, cb) {
        const temp = {
          secret,
        };

        axios.post('/api/accounts/open', { secret })
          .then(ret => {

            temp.secret = secret;
            temp.publicKey = ret.data.account.publicKey;
            temp.address = ret.data.account.address;
            temp.gny = ret.data.account.balance;

            return axios.get('/api/uia/balances/' + temp.address)
          })
          .then(ret => {
            temp.balances = ret.data.balances;
            temp.balances.push({
              balance: temp.gny,
              currency: 'GNY',
            });

            cb(null, temp);
          })
          .catch(err => {
            console.log(err.message);
            err.response && console.log(err.response.data);
            cb(err.message);
          });
      }
      function getBalances(address) {
        $.ajax({
          type: 'GET',
          url: '/api/uia/balances/' + address,
          dataType: 'json',
          success: function(ret) {
            console.log(ret);
            if (!ret.success) {
              alert(ret.error);
              return;
            }
            updateBalanceView(ret.balances);
          },
        });
      }
      function logout() {
        $('#loginBtn').html('Login');
        $('#secretInput').show();
        $('#mainPanel').hide();
        State.isLogin = false;
        if (State.timer) {
          clearInterval(State.timer);
          State.timer = null;
        }
      }

      $('#loginBtn').click(function() {
        if (State.isLogin) {
          logout();
        } else {
          login($('#secretInput').val(), (err, account) => {
            UserInfo = account;
            onLogin(account);
          });
        }
      });
      $('#invokeBtn').click(function() {
        var args = $('#contractArgs')
          .val()
          .split('\n');
        var info = $('#contractOptions').val();
        console.log(info);
        info = JSON.parse(info);

        var data = {
          type: info.type,
          fee: info.fee,
          secret: UserInfo.secret,
          args: args,
        };
        console.log('invoke', data);
        // axios.put()
        axios.put('/api/transactions', data, {
          headers: {
            magic: '594fe0f3',
          },
        })
          .then((response) => {
            console.log(response.data);
          })
          .catch(error => {
            console.log(error.response.data);
          });
      });
      $('#accessBtn').click(function() {
        var params = $('#accessParams').val();
        var jsonParams = null;
        try {
          if (params) {
            var jsonParams = JSON.parse(params);
          }
        } catch (e) {
          alert('Invalid params');
          return;
        }

        $.ajax({
          type: 'GET',
          url: $('#accessUrl').val(),
          data: jsonParams,
          dataType: 'json',
          success: function(ret) {
            console.log(ret);
            $('#accessResponse').val(JSON.stringify(ret, null, 4));
          },
        });
      });
    });
  </script>

  <body>
    <h1>Simple Wallet</h1>
    <div>
      <input
        type="password"
        id="secretInput"
        placeholder="Please input master secret"
      />
      <button id="loginBtn">Login</button>
    </div>
    <div id="mainPanel" style="display: none;">
      <hr />
      <h2>Account balances</h2>
      <div>
        <table id="balanceTable" width="200px" border="1">
          <tr>
            <th>Currency</th>
            <th>Balance</th>
          </tr>
        </table>
      </div>

      <hr />
      <h2>Contract invoke</h2>
      <div>
        <select id="contractOptions"></select
        ><input type="button" id="invokeBtn" value="Invoke" /><br />
        <textarea
          rows="6"
          cols="60"
          id="contractArgs"
          placeholder="Please input the arguments"
        ></textarea
        ><br />
      </div>

      <hr />
      <h2>My Transactions</h2>
      <div>
        <table id="transactionTable" width="200px" border="1">
          <tr>
            <th>Type</th>
            <th>Height</th>
            <th>Args</th>
            <th>Timestamp</th>
            <th>SenderId</th>
          </tr>
        </table>
      </div>
    </div>
  </body>
</html>
