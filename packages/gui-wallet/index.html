<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="https://unpkg.com/wingcss" />
    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
    <script src="https://unpkg.com/axios@0.18.0/dist/axios.js"></script>
    <title>Simple Wallet</title>
  </head>

  <script type="text/javascript">
    $(document).ready(function() {
      var COUNT_PER_PAGE = 20;
      var State = {
        isLogin: false,
        timer: null,
      };
      var UserInfo = {
        secret: '',
      };
      function updateBalanceView(balances) {
        var $table = $('#balanceTable');
        $table.find('tr:not(:first)').remove();
        for (var i in balances) {
          var balanceInfo = balances[i];
          var balance = Number(balanceInfo.balance) / 100000000;
          var currency = balanceInfo.currency;
          var tr =
            '<tr><td>' + currency + '</td>' + '<td>' + balance + '</td></tr>';
          $table.append(tr);
        }
      }
      function loadContracts() {
        var $contractOptions = $('#contractOptions');
        $contractOptions.empty();

        const transfer = JSON.stringify({ type: 0, fee: 0.1 * 1e8, });
        const setUserName = JSON.stringify({ type: 1, fee: 5 * 1e8, });
        const setSecondPassphrase = JSON.stringify({ type: 2, fee: 5 * 1e8, });
        const lock = JSON.stringify({ type: 3, fee: 0.1 * 1e8, });
        const vote = JSON.stringify({ type: 4, fee: 0.1 * 1e8, });
        const unvote = JSON.stringify({ type: 5, fee: 0.1 * 1e8, });
        const unlock = JSON.stringify({ type: 6, fee: 0 * 1e8, });
        const registerDelegate = JSON.stringify({ type: 10, fee: 100 * 1e8, })

        const registerIssuer = JSON.stringify({ type: 100, fee: 100 * 1e8, });
        const registerAsset = JSON.stringify({ type: 101, fee: 500 * 1e8, });
        const issue = JSON.stringify({ type: 102, fee: 0.1, });
        const assetTransfer = JSON.stringify({ type: 103, fee: 0.1 * 1e8, });

        $contractOptions.append(`<option value=${transfer}>#0 basic.transfer</option`);
        $contractOptions.append(`<option value="${setUserName}">#1 basic.setUserName</option`);
        $contractOptions.append(`<option value="${setSecondPassphrase}">#2 basic.setSecondPassPhrase</option`);
        $contractOptions.append(`<option value="${lock}">#3 basic.lock</option`);
        $contractOptions.append(`<option value="${vote}">#4 basic.vote</option`);
        $contractOptions.append(`<option value="${unvote}">#5 basic.unvote</option`);
        $contractOptions.append(`<option value="${unlock}">#6 basic.unlock</option`);
        $contractOptions.append(`<option value="${registerDelegate}">#10 basic.registerDelegate</option`);

        $contractOptions.append(`<option value="${registerIssuer}">#100 uia.registerIssuer</option`);
        $contractOptions.append(`<option value="${registerAsset}">#101 uia.registerAsset</option`);
        $contractOptions.append(`<option value="${issue}">#102 uia.issue</option`);
        $contractOptions.append(`<option value="${assetTransfer}">#103 uia.transfer</option`);
      }
      function onLogin(account) {
        State.isLogin = true;
        $('#loginBtn').html('Logout');
        $('#secretInput').hide();
        $('#mainPanel').show();
        updateBalanceView(account.balances);
        loadContracts();
      }
      function login(secret) {
        // http://localhost:4096/api/uia/balances/G4GDW6G78sgQdSdVAQUXdm5xPS13t
        $.ajax({
          type: 'POST',
          url: '/api/accounts/open',
          data: {
            secret: secret,
          },
          dataType: 'json',
          success: function(ret) {
            console.log(JSON.stringify(ret, null, 2));
            if (!ret.success) {
              alert(ret.error);
              return;
            }

            // get balances
            $.ajax({
              type: 'GET',
              url: '/api/uia/balances/' + ret.account.address,
              dataType: 'json',
              success: function (response) {
                if (!response) {
                  console.log(response.error);
                  return;
                }

                ret.account.balances = response.balances;
                ret.account.balances.push({
                  balance: ret.account.balance,
                  currency: 'GNY',
                });

                UserInfo.secret = secret;
                UserInfo.publicKey = ret.account.publicKey;
                UserInfo.address = ret.account.address;
                onLogin(ret.account);
              }
            })
          },
        });
      }
      function getBalances(address) {
        $.ajax({
          type: 'GET',
          url: '/api/uia/balances/' + address,
          dataType: 'json',
          success: function(ret) {
            console.log(ret);
            if (!ret.success) {
              alert(ret.error);
              return;
            }
            updateBalanceView(ret.balances);
          },
        });
      }
      function logout() {
        $('#loginBtn').html('Login');
        $('#secretInput').show();
        $('#mainPanel').hide();
        State.isLogin = false;
        if (State.timer) {
          clearInterval(State.timer);
          State.timer = null;
        }
      }

      State.timer = setInterval(function() {
        if (UserInfo.publicKey) {
          // getBalances(UserInfo.address);
        }
      }, 10 * 1000);
      $('#loginBtn').click(function() {
        if (State.isLogin) {
          logout();
        } else {
          login($('#secretInput').val());
        }
      });
      $('#invokeBtn').click(function() {
        var args = $('#contractArgs')
          .val()
          .split('\n');
        var info = $('#contractOptions').val();
        console.log(info);
        info = JSON.parse(info);

        var data = {
          type: info.type,
          fee: info.fee,
          secret: UserInfo.secret,
          args: args,
        };
        console.log('invoke', data);
        // axios.put()
        axios.put('/api/transactions', data, {
          headers: {
            magic: '594fe0f3',
          },
        })
          .then((response) => {
            console.log(response.data);
          })
          .catch(error => {
            console.log(error.response.data);
          });
      });
      $('#accessBtn').click(function() {
        var params = $('#accessParams').val();
        var jsonParams = null;
        try {
          if (params) {
            var jsonParams = JSON.parse(params);
          }
        } catch (e) {
          alert('Invalid params');
          return;
        }

        $.ajax({
          type: 'GET',
          url: $('#accessUrl').val(),
          data: jsonParams,
          dataType: 'json',
          success: function(ret) {
            console.log(ret);
            $('#accessResponse').val(JSON.stringify(ret, null, 4));
          },
        });
      });
    });
  </script>

  <body>
    <h1>Simple Wallet</h1>
    <div>
      <input
        type="password"
        id="secretInput"
        placeholder="Please input master secret"
      />
      <button id="loginBtn">Login</button>
    </div>
    <div id="mainPanel" style="display: none;">
      <hr />
      <h2>Account balances</h2>
      <div>
        <table id="balanceTable" width="200px" border="1">
          <tr>
            <th>Currency</th>
            <th>Balance</th>
          </tr>
        </table>
      </div>

      <hr />
      <h2>Contract invoke</h2>
      <div>
        <select id="contractOptions"></select
        ><input type="button" id="invokeBtn" value="Invoke" /><br />
        <textarea
          rows="6"
          cols="60"
          id="contractArgs"
          placeholder="Please input the arguments"
        ></textarea
        ><br />
      </div>

      <hr />
      <h2>Interface access</h2>
      <div>
        <input
          type="text"
          id="accessUrl"
          placeholder="Please input url"
        /><input type="button" id="accessBtn" value="Access" /><br />
        <textarea
          rows="10"
          cols="60"
          id="accessParams"
          placeholder="Please input params"
        ></textarea
        ><br />
        <textarea rows="20" cols="60" id="accessResponse"></textarea><br />
      </div>
    </div>
  </body>
</html>
